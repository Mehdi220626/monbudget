// ═══════════════════════════════════════════════
// MonBudget — Google Apps Script API
// Colle ce code dans Extensions → Apps Script
// ═══════════════════════════════════════════════

const SHEET_ID = '1fLUvlKE_bTmjCUhFnZxx2iW5zah13SCWWA5ctpzvyfA';

function getSheet(name) {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  let sheet = ss.getSheetByName(name);
  if (!sheet) {
    sheet = ss.insertSheet(name);
  }
  return sheet;
}

// Handle GET requests (read data)
function doGet(e) {
  try {
    const action = e.parameter.action;
    
    if (action === 'getAll') {
      const txSheet = getSheet('transactions');
      const incSheet = getSheet('incomes');
      const setSheet = getSheet('settings');
      
      const transactions = sheetToJson(txSheet);
      const incomes = sheetToJson(incSheet);
      const settings = sheetToJson(setSheet);
      
      return jsonResponse({
        success: true,
        transactions: transactions,
        incomes: incomes,
        settings: settings.length > 0 ? settings[0] : {}
      });
    }
    
    return jsonResponse({ success: false, error: 'Unknown action' });
  } catch (err) {
    return jsonResponse({ success: false, error: err.toString() });
  }
}

// Handle POST requests (write data)
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;
    
    if (action === 'sync') {
      // Full sync — replace all data
      if (data.transactions) {
        writeJsonToSheet(getSheet('transactions'), data.transactions);
      }
      if (data.incomes) {
        writeJsonToSheet(getSheet('incomes'), data.incomes);
      }
      if (data.settings) {
        writeJsonToSheet(getSheet('settings'), [data.settings]);
      }
      return jsonResponse({ success: true, timestamp: new Date().toISOString() });
    }
    
    if (action === 'addTransaction') {
      appendRow(getSheet('transactions'), data.transaction);
      return jsonResponse({ success: true });
    }
    
    if (action === 'addIncome') {
      appendRow(getSheet('incomes'), data.income);
      return jsonResponse({ success: true });
    }
    
    if (action === 'deleteTransaction') {
      deleteRowById(getSheet('transactions'), data.id);
      return jsonResponse({ success: true });
    }
    
    if (action === 'deleteIncome') {
      deleteRowById(getSheet('incomes'), data.id);
      return jsonResponse({ success: true });
    }
    
    if (action === 'updateTransaction') {
      updateRowById(getSheet('transactions'), data.id, data.updates);
      return jsonResponse({ success: true });
    }
    
    return jsonResponse({ success: false, error: 'Unknown action' });
  } catch (err) {
    return jsonResponse({ success: false, error: err.toString() });
  }
}

// ─── Helper functions ───

function sheetToJson(sheet) {
  const data = sheet.getDataRange().getValues();
  if (data.length < 2) return [];
  const headers = data[0];
  const rows = [];
  for (let i = 1; i < data.length; i++) {
    const obj = {};
    for (let j = 0; j < headers.length; j++) {
      let val = data[i][j];
      // Convert numeric strings back to numbers
      if (headers[j] === 'amount' || headers[j] === 'savingsGoal') {
        val = Number(val) || 0;
      }
      // Parse budgets JSON
      if (headers[j] === 'budgets' && typeof val === 'string' && val.startsWith('{')) {
        try { val = JSON.parse(val); } catch(e) {}
      }
      obj[headers[j]] = val;
    }
    rows.push(obj);
  }
  return rows;
}

function writeJsonToSheet(sheet, jsonArray) {
  // Clear sheet
  sheet.clear();
  if (!jsonArray || jsonArray.length === 0) return;
  
  // Get all unique keys across all objects
  const allKeys = new Set();
  jsonArray.forEach(obj => Object.keys(obj).forEach(k => allKeys.add(k)));
  const headers = Array.from(allKeys);
  
  // Write headers
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  
  // Write data
  if (jsonArray.length > 0) {
    const rows = jsonArray.map(obj => 
      headers.map(h => {
        const val = obj[h];
        // Stringify objects (like budgets)
        if (typeof val === 'object' && val !== null) return JSON.stringify(val);
        return val !== undefined ? val : '';
      })
    );
    sheet.getRange(2, 1, rows.length, headers.length).setValues(rows);
  }
}

function appendRow(sheet, obj) {
  const data = sheet.getDataRange().getValues();
  let headers;
  
  if (data.length === 0 || (data.length === 1 && data[0][0] === '')) {
    // Sheet is empty, create headers
    headers = Object.keys(obj);
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  } else {
    headers = data[0];
    // Add any new columns
    Object.keys(obj).forEach(k => {
      if (!headers.includes(k)) {
        headers.push(k);
        sheet.getRange(1, headers.length).setValue(k);
      }
    });
  }
  
  const row = headers.map(h => {
    const val = obj[h];
    if (typeof val === 'object' && val !== null) return JSON.stringify(val);
    return val !== undefined ? val : '';
  });
  sheet.appendRow(row);
}

function deleteRowById(sheet, id) {
  const data = sheet.getDataRange().getValues();
  if (data.length < 2) return;
  const idCol = data[0].indexOf('id');
  if (idCol === -1) return;
  
  for (let i = data.length - 1; i >= 1; i--) {
    if (data[i][idCol] === id) {
      sheet.deleteRow(i + 1);
      return;
    }
  }
}

function updateRowById(sheet, id, updates) {
  const data = sheet.getDataRange().getValues();
  if (data.length < 2) return;
  const headers = data[0];
  const idCol = headers.indexOf('id');
  if (idCol === -1) return;
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][idCol] === id) {
      Object.keys(updates).forEach(key => {
        const col = headers.indexOf(key);
        if (col !== -1) {
          sheet.getRange(i + 1, col + 1).setValue(updates[key]);
        }
      });
      return;
    }
  }
}

function jsonResponse(data) {
  return ContentService
    .createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}
